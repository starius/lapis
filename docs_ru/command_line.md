title: Command Line Interface
--
# Интерфейс командной строки

## Описание команд

Через командную строку можно управлять проектами Lapis.

Некоторые команды принимают окружение в аргументах.
Если окружение не передать, то будет использоваться
окружение по умолчанию, которое определяется
согласно следующим правилам: если в текущей папке есть файл
`lapis_environment.lua`, то в качестве окружения
используется то, что он возвращает,
иначе используется окружение `development`.

К примеру, если создать следующий файл,
то окружение по умолчанию будет `production`:

```lua
-- lapis_environment.lua
return "production"
```

### `lapis new`

```bash
$ lapis new [--git] [--tup] [--lua]
```

Создаёт пустой сайт в текущей папке.
По умолчанию создаются следующие файлы:

* `nginx.conf`
* `mime.types`
* `app.moon`

Эти файлы надо изменить под свой проект.

С помощью опций можно создать дополнительные файлы.

Опция `--git` создаёт `.gitignore` со следующими строками:

    *.lua
    logs/
    nginx.conf.compiled

Опция `--tup` создаёт файлы `Tupfile` и `Tuprules.tup`,
которые используются системой сборки
[Tup](http://gittup.org/tup/).
Файл содержит правило трансляции MoonScript в Lua.

Если передать опцию `--lua`, то пустой сайт будет
основан на Lua, а не на MoonScript.

### `lapis server`

```bash
$ lapis server [environment]
```

Запускает OpenResty.
Собирает конфиг для Nginx, создаёт папку с логами,
если её нет, и запускает сервер с соответствующим окружением.

Запускается не просто Nginx, а OpenResty.
Его ищут в папках, куда обычно устанавливают OpenResty.

Lapis ищет OpenResty в следующих папках:

    "/usr/local/openresty/nginx/sbin/"
    "/usr/local/opt/openresty/bin/"
    "/usr/sbin/"
    ""

Чтобы использовать OpenResty, установленный в
другое место, надо указать путь к нему
в переменной окружения `LAPIS_OPENRESTY`:

    LAPIS_OPENRESTY=/home/leafo/bin/openresty lapis server

Сервер запускается с помощью следующей команды
(где `nginx` - путь к найденному OpenResty):

```bash
$ nginx -p "$(pwd)"/ -c "nginx.conf.compiled"
```

### `lapis build`

```bash
$ lapis build [environment]
```

Пересобирает конфиг.
Если сервер в данный момент запущен,
то ему передаётся сигнал `HUP`
(перезагрузка конфигурации).
По умолчанию Nginx не отслеживает изменения конфига
самостоятельно.
Команда `lapis build` позволяет обновить конфиг
без перезапуска сервера.

Во время перезагрузки конфигурации все рабочие процессы Nginx
перезапускаются, поэтому весь код приложения тоже
перезагружается.

Это оптимальный способ обновления сайта,
запущенного в боевом режиме.
Сайт полностью перезагружается, ни один запрос
от пользователя не теряется.

См. также [учебник Nginx](http://wiki.nginx.org/CommandLine#Loading_a_New_Configuration_Using_Signals).

### `lapis migrate`

```bash
$ lapis migrate [environment]
```

Производит применение всех ожидающих миграций.
При необходимости создаёт таблицу миграций.

Для этой команды нужен модуль `migrations`.
См. также [руководство по
миграциям](#database-migrations-running-migrations).

Выполняется примерно такой код:

```moon
import run_migrations from require "lapis.db.migrations"
run_migrations require "migrations"
```

### `lapis term`

Выключает работающий сервер при помощи сигнала TERM.
Эта команда имеет смысл, только если Nginx запущен
в фоновом режиме,
иначе его можно остановить при помощи Ctrl+C.
