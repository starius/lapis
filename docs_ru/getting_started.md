title: Введение
--
# Введение

[Lapis](http://leafo.net/lapis/) - веб-фреймворк
для Lua и MoonScript.
Lapis замечателен тем, что построен на основе
[OpenResty][0] (сборка Nginx).
Код веб-приложения исполняется в самом Nginx.
Пользуясь циклом обработки событий Nginx, можно запускать
асинхронные HTTP-запросы, запросы к БД и другие запросы
с помощью модулей, входящих в состав OpenResty.
Благодаря сопрограммам Lua удаётся писать
асинхронный код, который выглядит так же, как синхронный.

Lapis включает не только веб-фреймворк, но и инструменты
управления OpenResty в различных конфигурациях,
которые могут использоваться отдельно от веб-фреймворка.

В веб-фреймворк входит обработчик URL, HTML-шаблоны,
защита от CSRF, сессии, система моделей
для работы с БД PostgreSQL и MySQL и другие полезные функции,
необходимые для разработки веб-сайтов.

Этот документ выступает в роли учебника и
справочника по Lapis.

## Базовая настройка

Установите OpenResty.
Если пользуетесь Heroku, используйте
модули Heroku [OpenResty][4] и [Lua build pack][3].

Затем установите Lapis через LuaRocks:

```bash
$ luarocks install lapis
```

## Создание проекта

### Команда `lapis`

В пакет Lapis входит утилита командной строки
для создания проекта и запуска сервера.
Чтобы получить полный список её возможностей,
запустите следующую команду:

```bash
$ lapis help
```

Начнём с создания нового проекта.
Перейдите в пустую папку и запустите:

```bash
$  lapis new

wrote	nginx.conf
wrote	mime.types
wrote	app.moon
```

> Если вы хотите получить приложение на Lua,
> а не на MoonScript, добавьте опцию `--lua`.
> См. также [раздел про создание приложений на
> Lua]($root/reference/lua_getting_started.html).

Мы получили базовую конфигурацию Nginx и пустое
приложение Lapis.

Посмотрите созданные файлы. Самый важный среди них
`nginx.conf`. Вот что в нем написано:

 * Запросы к пути `/static/` соответствуют статическим файлам
    внутри папки `static` (создайте её)
 * Запросы к `/favicon.ico` получают в ответ файл
    `static/favicon.ico`
 * Все остальные запросы обрабатывает Lua,
    точнее модуль `"app"`

При запуске сервера с помощью команды `lapis server`
препроцессируется файл `nginx.conf`: в него подставляются
переменные из текущего окружения Lapis и результат
записывается в файл `nginx.conf.compiled`.

### Конфигурация Nginx

Посмотрим более пристально на конфигурацию Nginx, которую
создает `lapis new` (файл `nginx.conf`).
Можно вернуться к этому позже, но важно понимать,
как это работает, чтобы "заточить" конфигурацию под себя
или хотя бы запустить приложение в боевых условиях.

Содержимое файла `nginx.conf`:

```nginx
worker_processes ${{NUM_WORKERS}};
error_log stderr notice;
daemon off;

events {
  worker_connections 1024;
}

http {
  include mime.types;

  server {
    listen ${{PORT}};
    lua_code_cache ${{CODE_CACHE}};

    location / {
      default_type text/html;
      content_by_lua '
        require("lapis").serve("app")
      ';
    }

    location /static/ {
      alias static/;
    }

    location /favicon.ico {
      alias static/favicon.ico;
    }
  }
}
```

Во-первых, этот файл пока не является работающей конфигурацией
Nginx. В нём есть несколько переменных (${{VARIABLE}}),
значения которых подставляются из текущего окружения Lapis.

Во-вторых, директива `daemon off` не даёт серверу уйти
в фоновый режим, а `error_log stderr notice`
указывает, что лог надо выводить на консоль.
Это полезно при разработке, но стоит отключить
в боевом режиме.

Параметр `lua_code_cache` тоже полезен при разработке.
Если его значение равно `off`, то все модули Lua
перезагружаются при каждом запросе.
Благодаря этому изменения кода сайта видны сразу.
А в боевом режиме кеширование Lua-кода надо включить
для увеличения производительности.
По умолчанию значение `off`.

В директиве `content_by_lua` записан код Lua,
который обрабатывает все запросы, которые не попали в
другие `location`ы.
Этот код загружает Lapis с модулем `"app"`.
(Костяк сайта в модуле `app` был создан командой `lapis new`.)

## Запуск сервера

Хотя Nginx можно запустить и вручную,
Lapis предоставляет удобную команду `lapis server`,
которая препроцессирует файл конфигурации и
запускает сервер.

Lapis пытается найти установленный OpenResty
в следующих папках:

    "/usr/local/openresty/nginx/sbin/"
    "/usr/local/opt/openresty/bin/"
    "/usr/sbin/"
    ""

Последняя запись обозначает все пути, которые
есть в переменной `PATH`.

> Вам нужен именно OpenResty, а не обычный Nginx.
> Lapis пропускает обычные установки Nginx.

Теперь запустим сервер:

```bash
$ lapis server
```

Конфигурация по умолчанию не уводит сервер в фоновый режим,
поэтому нажмите `Ctrl+C` для его отключения.

Если сервер работает в фоновом режиме, его можно остановить
при помощи команды `lapis term`, запущенной в корневой папке
приложения. Эта команда получает номер процесса из PID-файла
и посылает сигнал `TERM`, если процесс существует.

## Создание приложения

Теперь вы умеете создавать новый проект и запускать
и останавливать сервер.
Перейдём к созданию самого приложения.
Этот раздел разбит на две части: для MoonScript и для Lua.

Если не знаете, с чего начать, советуем прочитать обе части.

 * [Создание приложения на Lua][1]
 * [Создание приложения на MoonScript][2]

> Последующие разделы включают примеры кода на MoonScript
> и на Lua. Язык можно переключать с помощью кнопок
> *MoonScript* and *Lua*, расположенных над списком разделов
> (всплывающее меню слева).

[0]: http://openresty.org/
[1]: lua_getting_started.html
[2]: moon_getting_started.html
[3]: https://github.com/leafo/heroku-buildpack-lua
[4]: https://github.com/leafo/heroku-openresty
